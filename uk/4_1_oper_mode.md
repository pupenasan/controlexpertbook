# 4.  Налагодження програм користувача та діагностика ПЛК

## 4.1. Операційні режими роботи ПЛК

Працюючий ПЛК може знаходитись в режимах *RUN*, *STOP* та *HALT*. У режимі *виконання* (*RUN*) всі Задачі виконуються згідно послідовності описаної в параграфі 3.3.1. Перехід в *RUN* може проводитись різними способами: 

-     автоматично при холодному старті ПЛК, якщо виставлена опція "*Automatic* *Start* *in* *Run"* в настройках процесорного модулю;

-     подавши *TRUE* на налаштований для цього дискретний вхід, якщо цей вхід виставлений настройкою процесорного модулю "*Run/Stop Input"*; 

-     командою *START* з UNITY PRO, якщо ПЛК находиться в режимі *STOP*;

У режимі *зупинки* (*STOP*) відбувається тільки циклічне опитування всіх входів та внутрішня обробка. Тобто не виконуються програми користувача в Задачах, а виходи ПЛК виставляються в безпечний стан, відповідно до їх конфігурації (див. розділ 2). Нагадаємо, що у всіх режимах (включаючи і *STOP*) операційна система UNITY працює і виконує визначені в ній функції. Перехід в *STOP* може проводитись різними способами:

-     автоматично при холодному старті ПЛК, якщо знята опція "*Automatic* *Start* *in* *Run"* в настройках процесорного модулю;

-     подавши *FALSE* на налаштований для цього дискретний вхід, якщо цей вхід виставлений настройкою процесорного модулю "*Run/Stop Input"*; 

-     командою *STOP* з UNITY PRO, якщо ПЛК находиться в режимі *START*;

-     командою *INIT* з UNITY PRO, якщо ПЛК находиться в режимі *HALT*;

Режим *HALT* *(аварійна зупинка)* аналогічний режиму *STOP*, однак виникає в результаті помилок програм, спрацювання сторожового таймеру або виконання в програмі спеціальної інструкції *HALT*. Для можливості переводу ПЛК з режиму *HALT* в *STOP* необхідно запустити команду ініціалізації *INIT* з UNITY PRO (*PLC->Init*).

Кожна Задача в свою чергу теж може перебувати в режимах *RUN* і *STOP*. Коли ПЛК перебуває в режимі *RUN* Задачі теж автоматично запускаються відповідно до конфігурації. Використовуючи діагностичні вікна UNITY PRO можна зупиняти/запускати виконання окремих Задач. Це може знадобитися для тонкого налагодження програми користувача. Крім того Задачі можуть перебувати в режимі *BKPT* *(BreakPoint)*, в який переводиться Задача при використанні точок переривання. Слід пам’ятати, що:

-     точка переривання призупиняє виконання Задачі, в якій вона використана! 

-     при від’єднанні від ПЛК з включеним режимом *BKPT*, він переходить в режим *STOP*!

При включенні ПЛК відбувається його *холодний старт* (*Cold* *Start*). При холодному старті проходять всі стадії ініціалізації ПЛК:

-     самодіагностика;

-     завантаження виконавчого проекту з карти SD в пам’ять (тільки для М340);

-     конфігурування всіх модулів;

-     деактивація всіх Задач окрім MAST;

-     ініціалізація змінних (крім позначених як *Save*) та обнуління області *%MW* (якщо в конфігурації процесорного модуля стоїть опція "*Initialize %MWi on cold start"*);

-     ініціалізація екземплярів функціональних блоків;

-     ініціалізація системних змінних;

-     запис в *%S0:=TRUE* і в *%SW10.0:= FALSE*; 

Після ініціалізації, в залежності від настройок процесорного модуля ("*Automatic start in Run"* та *"Run/Stop Input"*), ПЛК переходить в режим *STOP* або *RUN*.  У режимі *RUN* на першому циклі виконання Задачі MAST, ПЛК робить наступні дії:

-        в кінці Задачі записує в *%S0:=FALSE,* *%SW10.0:= TRUE,* *%S13:= FALSE*;

-        в кінці Задачі запускає всі інші сконфігуровані в проекті Задачі;

До холодного старту ПЛК приводять наступні події:

1)  повне завантаження виконавчого проекту в ПЛК (*Transfer* *Project* *to* *PLC*); при цьому ПЛК завжди переходить в режим *STOP*;

2)  завантаження виконавчого проекту з SD карти в пам’ять (тільки для М340); завантаження проходить якщо ці проекти відрізняються або при команді з UNITY PRO *PLC->Project backup*;

3)  натискання кнопки *RESET* на модулі живлення процесорного шасі (тільки для M340); 

4)  натискання кнопки *RESET* на процесорному модулі(тільки для TSX Premium);

5)  вставка PCMCIA карти пам’яті (тільки для TSX Premium);

6)  запис в *%S0:=TRUE* в програмі, або з діагностичних вікон UNITY PRO; при цьому перезапускається тільки прикладна програма;

7)  відновлення після збою в живленні, якщо контекст програми відрізняється від збереженого при зникненні живлення.      

У момент зникнення живлення, процесорний модуль встигає перейти в режим *STOP* та записати *контекст прикладної програми* (*application* *context* - стан регістрів процесору та пам’яті). При появі живлення, під час самодіагностики, CPU перевіряє дійсний контекст програми зі збереженим. Якщо контексти різні – проходить холодний старт, якщо співпадають – *теплий рестарт* (*Warm Restart*).

Під час теплого рестарту ПЛК деактивуються усі Задачі, окрім MAST, біт *%S1:=TRUE*, після чого Задача MAST переводиться в режим *RUN*. У кінці першого циклу Задачі MAST активуються усі інші Задачі, а *%S1:=FALSE.* Для TSX Premium до теплого рестарту приводить також натискання кнопки *RESET* на модулі живлення процесорного шасі. Біт *%S1* можна змінювати з прикладної програми або з діагностичних вікон UNITY PRO, що приводить до перезапуску Задачі *MAST*.

Стан ПЛК сигналізується індикаторними лампами на CPU та відображається в UNITY PRO (в режимі онлайн) на панелі статусу (див. рис.4.4) та в діагностичних вікнах.   

 